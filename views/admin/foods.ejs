<%- include('../partials/header') %>
<%- include('../partials/navbar-admin') %>

<div class="dashboard admin-dashboard">
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-apple-alt"></i> Manage Foods</h1>
            <p>Add, edit, or remove items from the food database</p>
        </div>

        <% if (success) { %>
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <%= success %>
            </div>
        <% } %>

        <% if (errors && errors.length > 0) { %>
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <ul>
                    <% errors.forEach(error => { %>
                        <li><%= error.msg %></li>
                    <% }); %>
                </ul>
            </div>
        <% } %>

        <!-- Add Food Form -->
        <div class="dashboard-card">
            <h2>Add New Food</h2>
            <form action="/admin/foods/add" method="POST" class="food-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Food Name</label>
                        <input type="text" id="name" name="name" required>
                    </div>

                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category" name="category" required>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                            <option value="snack">Snack</option>
                            <option value="beverage">Beverage</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="calories">Calories</label>
                        <input type="number" id="calories" name="calories" step="0.1" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="protein">Protein (g)</label>
                        <input type="number" id="protein" name="protein" step="0.1" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="carbs">Carbs (g)</label>
                        <input type="number" id="carbs" name="carbs" step="0.1" min="0" required>
                    </div>

                    <div class="form-group">
                        <label for="fats">Fats (g)</label>
                        <input type="number" id="fats" name="fats" step="0.1" min="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="servingSize">Serving Size</label>
                    <input type="text" id="servingSize" name="servingSize" placeholder="e.g., 100g, 1 cup, 1 piece" value="100g">
                </div>

                <button type="submit" class="btn-primary">
                    <i class="fas fa-plus"></i> Add Food
                </button>
            </form>
        </div>

        <!-- Search Bar -->
        <div class="dashboard-card">
            <form action="/admin/foods" method="GET" class="search-form">
                <div class="search-group">
                    <input type="text" name="search" placeholder="Search foods..." value="<%= search %>">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <% if (search) { %>
                        <a href="/admin/foods" class="btn-outline">Clear</a>
                    <% } %>
                </div>
            </form>
        </div>

        <!-- Foods Table -->
        <div class="dashboard-card">
            <h2>Food Database (<%= foods.length %>)</h2>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Calories</th>
                            <th>Protein</th>
                            <th>Carbs</th>
                            <th>Fats</th>
                            <th>Serving</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (foods.length > 0) { %>
                            <% foods.forEach(food => { %>
                                <tr>
                                    <td><%= food.name %></td>
                                    <td><%= food.category.charAt(0).toUpperCase() + food.category.slice(1) %></td>
                                    <td><%= food.calories %> kcal</td>
                                    <td><%= food.protein %>g</td>
                                    <td><%= food.carbs %>g</td>
                                    <td><%= food.fats %>g</td>
                                    <td><%= food.servingSize %></td>
                                    <td>
                                        <button class="btn-sm btn-outline" onclick="editFood('<%= food._id %>', '<%= food.name %>', <%= food.calories %>, <%= food.protein %>, <%= food.carbs %>, <%= food.fats %>, '<%= food.servingSize %>', '<%= food.category %>')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <form action="/admin/foods/delete/<%= food._id %>" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this food?');">
                                            <button type="submit" class="btn-danger btn-sm">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="8" class="text-center">No foods found</td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <% if (totalPages > 1) { %>
                <div class="pagination">
                    <% if (currentPageNum > 1) { %>
                        <a href="/admin/foods?page=<%= currentPageNum - 1 %><%= search ? '&search=' + search : '' %>" class="btn-outline">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    <% } %>
                    
                    <span class="page-info">Page <%= currentPageNum %> of <%= totalPages %></span>
                    
                    <% if (currentPageNum < totalPages) { %>
                        <a href="/admin/foods?page=<%= currentPageNum + 1 %><%= search ? '&search=' + search : '' %>" class="btn-outline">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    <% } %>
                </div>
            <% } %>
        </div>
    </div>
</div>

<!-- Edit Food Modal -->
<div id="editFoodModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Food</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editFoodForm">
            <input type="hidden" id="editFoodId">
            
            <div class="form-group">
                <label for="editName">Food Name</label>
                <input type="text" id="editName" name="name" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editCalories">Calories</label>
                    <input type="number" id="editCalories" name="calories" step="0.1" min="0" required>
                </div>

                <div class="form-group">
                    <label for="editProtein">Protein (g)</label>
                    <input type="number" id="editProtein" name="protein" step="0.1" min="0" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editCarbs">Carbs (g)</label>
                    <input type="number" id="editCarbs" name="carbs" step="0.1" min="0" required>
                </div>

                <div class="form-group">
                    <label for="editFats">Fats (g)</label>
                    <input type="number" id="editFats" name="fats" step="0.1" min="0" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="editServingSize">Serving Size</label>
                    <input type="text" id="editServingSize" name="servingSize" required>
                </div>

                <div class="form-group">
                    <label for="editCategory">Category</label>
                    <select id="editCategory" name="category" required>
                        <option value="breakfast">Breakfast</option>
                        <option value="lunch">Lunch</option>
                        <option value="dinner">Dinner</option>
                        <option value="snack">Snack</option>
                        <option value="beverage">Beverage</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <button type="submit" class="btn-primary btn-block">
                <i class="fas fa-save"></i> Update Food
            </button>
        </form>
    </div>
</div>

<script src="/js/admin-foods.js"></script>
<%- include('../partials/footer') %>
