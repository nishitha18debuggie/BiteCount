<%- include('../partials/header') %>
<%- include('../partials/navbar-admin') %>

<div class="dashboard admin-dashboard">
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-chart-bar"></i> Reports & Analytics</h1>
            <p>View system-wide statistics and insights</p>
        </div>

        <!-- Overview Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon users">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3>Total Users</h3>
                    <p class="stat-value"><%= totalUsers %></p>
                    <p class="stat-label">Registered</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon streak">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="stat-content">
                    <h3>Active Streaks</h3>
                    <p class="stat-value"><%= totalActiveStreaks %></p>
                    <p class="stat-label">Users with streaks</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon engagement">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <h3>Engagement Rate</h3>
                    <p class="stat-value"><%= totalUsers > 0 ? Math.round((totalActiveStreaks / totalUsers) * 100) : 0 %>%</p>
                    <p class="stat-label">Active users</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon growth">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div class="stat-content">
                    <h3>Platform Health</h3>
                    <p class="stat-value">Good</p>
                    <p class="stat-label">Overall status</p>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="reports-grid">
            <div class="dashboard-card">
                <h2>7-Day User Activity</h2>
                <canvas id="activityChart"></canvas>
            </div>

            <div class="dashboard-card">
                <h2>Average Calories per Day</h2>
                <canvas id="caloriesChart"></canvas>
            </div>
        </div>

        <!-- Detailed Analytics -->
        <div class="dashboard-card">
            <h2>Weekly Analytics Summary</h2>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Active Users</th>
                            <th>Total Logs</th>
                            <th>Avg Calories</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% chartData.forEach(day => { %>
                            <tr>
                                <td><%= new Date(day.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %></td>
                                <td><%= day.activeUsers %></td>
                                <td><%= day.totalLogs %></td>
                                <td><%= day.avgCalories %> kcal</td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Insights -->
        <div class="insights-section">
            <h2>Key Insights</h2>
            <div class="insights-grid">
                <div class="insight-card">
                    <i class="fas fa-lightbulb"></i>
                    <h3>User Engagement</h3>
                    <p>
                        <% if (totalActiveStreaks > 0) { %>
                            <%= totalActiveStreaks %> users are actively tracking their meals, showing strong engagement with the platform.
                        <% } else { %>
                            Encourage users to start tracking their meals to build healthy habits.
                        <% } %>
                    </p>
                </div>

                <div class="insight-card">
                    <i class="fas fa-trophy"></i>
                    <h3>Platform Growth</h3>
                    <p>
                        <% if (totalUsers > 0) { %>
                            The platform has <%= totalUsers %> registered users. Keep adding valuable features to retain and grow the user base.
                        <% } else { %>
                            Start promoting the platform to attract new users.
                        <% } %>
                    </p>
                </div>

                <div class="insight-card">
                    <i class="fas fa-chart-pie"></i>
                    <h3>Data Quality</h3>
                    <p>Users are actively logging their meals and exercises. Ensure the food database remains comprehensive and up-to-date.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const chartData = <%- JSON.stringify(chartData) %>;
    const labels = chartData.map(d => {
        const date = new Date(d.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    // Activity Chart
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Active Users',
                    data: chartData.map(d => d.activeUsers),
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Total Logs',
                    data: chartData.map(d => d.totalLogs),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Calories Chart
    const caloriesCtx = document.getElementById('caloriesChart').getContext('2d');
    new Chart(caloriesCtx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Average Calories',
                data: chartData.map(d => d.avgCalories),
                backgroundColor: '#f59e0b',
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>

<%- include('../partials/footer') %>
