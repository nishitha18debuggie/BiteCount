<%- include('../partials/header') %>
<%- include('../partials/navbar-user') %>

<div class="dashboard">
    <div class="container">
        <div class="dashboard-header">
            <h1>Welcome back, <%= user.fullName %>! ðŸ‘‹</h1>
            <p>Here's your progress for today</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon calories">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="stat-content">
                    <h3>Calories Consumed</h3>
                    <p class="stat-value"><%= caloriesConsumed %> / <%= calorieGoal %></p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: <%= Math.min((caloriesConsumed / calorieGoal) * 100, 100) %>%"></div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon exercise">
                    <i class="fas fa-dumbbell"></i>
                </div>
                <div class="stat-content">
                    <h3>Calories Burned</h3>
                    <p class="stat-value"><%= caloriesBurned %></p>
                    <p class="stat-label">kcal</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon net">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div class="stat-content">
                    <h3>Net Calories</h3>
                    <p class="stat-value <%= netCalories > calorieGoal ? 'over' : 'under' %>"><%= netCalories %></p>
                    <p class="stat-label">kcal</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon streak">
                    <i class="fas fa-fire-alt"></i>
                </div>
                <div class="stat-content">
                    <h3>Current Streak</h3>
                    <p class="stat-value"><%= user.currentStreak %></p>
                    <p class="stat-label">days</p>
                </div>
            </div>
        </div>

        <!-- Macros & Charts -->
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h2>Today's Macronutrients</h2>
                <canvas id="macroChart"></canvas>
                <div class="macro-legend">
                    <div class="legend-item">
                        <span class="legend-color protein"></span>
                        <span>Protein: <%= totalProtein %>g</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color carbs"></span>
                        <span>Carbs: <%= totalCarbs %>g</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color fats"></span>
                        <span>Fats: <%= totalFats %>g</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-card">
                <h2>Calorie Balance</h2>
                <canvas id="calorieChart"></canvas>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2>Quick Actions</h2>
            <div class="actions-grid">
                <a href="/user/food-log" class="action-card">
                    <i class="fas fa-utensils"></i>
                    <h3>Log Food</h3>
                    <p>Add your meals</p>
                </a>
                <a href="/user/exercise-log" class="action-card">
                    <i class="fas fa-running"></i>
                    <h3>Log Exercise</h3>
                    <p>Track your workout</p>
                </a>
                <a href="/user/progress" class="action-card">
                    <i class="fas fa-chart-line"></i>
                    <h3>View Progress</h3>
                    <p>See your trends</p>
                </a>
                <a href="/user/profile" class="action-card">
                    <i class="fas fa-user-cog"></i>
                    <h3>Update Profile</h3>
                    <p>Manage your info</p>
                </a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity">
            <h2>Today's Activity</h2>
            
            <% if (foodLogs.length > 0 || exerciseLogs.length > 0) { %>
                <div class="activity-list">
                    <% foodLogs.forEach(log => { %>
                        <div class="activity-item food">
                            <i class="fas fa-utensils"></i>
                            <div class="activity-details">
                                <h4><%= log.foodName %></h4>
                                <p><%= log.mealType.charAt(0).toUpperCase() + log.mealType.slice(1) %> â€¢ <%= log.calories %> kcal</p>
                            </div>
                            <span class="activity-time"><%= new Date(log.createdAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></span>
                        </div>
                    <% }); %>

                    <% exerciseLogs.forEach(log => { %>
                        <div class="activity-item exercise">
                            <i class="fas fa-dumbbell"></i>
                            <div class="activity-details">
                                <h4><%= log.exerciseName %></h4>
                                <p><%= log.duration %> min â€¢ <%= log.caloriesBurned %> kcal burned</p>
                            </div>
                            <span class="activity-time"><%= new Date(log.createdAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) %></span>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <div class="empty-state">
                    <i class="fas fa-clipboard-list"></i>
                    <p>No activity logged today. Start by logging your meals or exercises!</p>
                </div>
            <% } %>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Macro Pie Chart
    const macroCtx = document.getElementById('macroChart').getContext('2d');
    new Chart(macroCtx, {
        type: 'doughnut',
        data: {
            labels: ['Protein', 'Carbs', 'Fats'],
            datasets: [{
                data: [<%= totalProtein %>, <%= totalCarbs %>, <%= totalFats %>],
                backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Calorie Bar Chart
    const calorieCtx = document.getElementById('calorieChart').getContext('2d');
    new Chart(calorieCtx, {
        type: 'bar',
        data: {
            labels: ['Consumed', 'Burned', 'Goal'],
            datasets: [{
                label: 'Calories',
                data: [<%= caloriesConsumed %>, <%= caloriesBurned %>, <%= calorieGoal %>],
                backgroundColor: ['#10b981', '#f59e0b', '#6366f1'],
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>

<%- include('../partials/footer') %>
