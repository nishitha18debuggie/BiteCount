<%- include('../partials/header') %>
<%- include('../partials/navbar-user') %>

<div class="dashboard">
    <div class="container">
        <div class="dashboard-header">
            <div>
                <h1><i class="fas fa-user-circle"></i> Your Profile</h1>
                <p style="color: var(--text-secondary);">Manage your account and personal information</p>
            </div>
        </div>

        <% if (success) { %>
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <%= success %>
            </div>
        <% } %>

        <% if (errors && errors.length > 0) { %>
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <ul>
                    <% errors.forEach(error => { %>
                        <li><%= error.msg %></li>
                    <% }); %>
                </ul>
            </div>
        <% } %>

        <!-- Health Metrics Cards (Top Row) -->
        <% 
        const heightInMeters = user.height / 100;
        const bmi = (user.weight / (heightInMeters * heightInMeters)).toFixed(1);
        let bmiCategory = '';
        let bmiColor = '';
        if (bmi < 18.5) {
            bmiCategory = 'Underweight';
            bmiColor = '#3b82f6';
        } else if (bmi < 25) {
            bmiCategory = 'Normal';
            bmiColor = '#10b981';
        } else if (bmi < 30) {
            bmiCategory = 'Overweight';
            bmiColor = '#f59e0b';
        } else {
            bmiCategory = 'Obese';
            bmiColor = '#ef4444';
        }
        const bmr = Math.round(user.calculateBMR());
        const tdee = user.calculateTDEE();
        %>

        <div class="stats-grid-advanced" style="margin-bottom: 2rem;">
            <div class="stat-card-advanced">
                <div class="stat-icon-advanced" style="background: <%= bmiColor %>;">
                    <i class="fas fa-weight"></i>
                </div>
                <div class="stat-label-advanced">Body Mass Index</div>
                <div class="stat-value-large"><%= bmi %></div>
                <div class="badge-advanced" style="background: <%= bmiColor %>20; color: <%= bmiColor %>; margin-top: 0.5rem;">
                    <%= bmiCategory %>
                </div>
            </div>

            <div class="stat-card-advanced">
                <div class="stat-icon-advanced" style="background: var(--gradient-primary);">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <div class="stat-label-advanced">Basal Metabolic Rate</div>
                <div class="stat-value-large"><%= bmr %></div>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                    kcal/day at rest
                </p>
            </div>

            <div class="stat-card-advanced">
                <div class="stat-icon-advanced" style="background: var(--gradient-accent);">
                    <i class="fas fa-fire-alt"></i>
                </div>
                <div class="stat-label-advanced">Total Daily Energy</div>
                <div class="stat-value-large"><%= tdee %></div>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                    kcal/day with activity
                </p>
            </div>

            <div class="stat-card-advanced">
                <div class="stat-icon-advanced" style="background: var(--gradient-secondary);">
                    <i class="fas fa-bullseye"></i>
                </div>
                <div class="stat-label-advanced">Daily Goal</div>
                <div class="stat-value-large"><%= user.calorieGoal %></div>
                <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                    kcal target
                </p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="profile-grid-redesigned">
            <!-- Left Column: Personal Info -->
            <div class="profile-section">
                <div class="section-header">
                    <h2><i class="fas fa-user-edit"></i> Personal Information</h2>
                </div>
                <form action="/user/profile" method="POST" class="profile-form-enhanced">
                    <div class="form-group-advanced">
                        <label class="form-label-advanced">Full Name</label>
                        <input type="text" name="fullName" class="form-input-advanced" 
                            value="<%= user.fullName %>" required>
                    </div>

                    <div class="form-group-advanced">
                        <label class="form-label-advanced">Email Address</label>
                        <input type="email" class="form-input-advanced" 
                            value="<%= user.email %>" disabled>
                        <small style="color: var(--text-tertiary); font-size: 0.75rem; margin-top: 0.5rem; display: block;">
                            <i class="fas fa-lock"></i> Email cannot be changed
                        </small>
                    </div>

                    <div class="form-row">
                        <div class="form-group-advanced">
                            <label class="form-label-advanced">Age</label>
                            <input type="number" name="age" class="form-input-advanced" 
                                value="<%= user.age %>" min="13" max="120" required>
                        </div>

                        <div class="form-group-advanced">
                            <label class="form-label-advanced">Gender</label>
                            <select name="gender" class="form-input-advanced" disabled>
                                <option value="male" <%= user.gender === 'male' ? 'selected' : '' %>>Male</option>
                                <option value="female" <%= user.gender === 'female' ? 'selected' : '' %>>Female</option>
                                <option value="other" <%= user.gender === 'other' ? 'selected' : '' %>>Other</option>
                            </select>
                            <small style="color: var(--text-tertiary); font-size: 0.75rem; margin-top: 0.5rem; display: block;">
                                <i class="fas fa-lock"></i> Gender cannot be changed
                            </small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group-advanced">
                            <label class="form-label-advanced">Height (cm)</label>
                            <input type="number" name="height" class="form-input-advanced" 
                                value="<%= user.height %>" min="50" max="300" step="0.1" required>
                        </div>

                        <div class="form-group-advanced">
                            <label class="form-label-advanced">Weight (kg)</label>
                            <input type="number" name="weight" class="form-input-advanced" 
                                value="<%= user.weight %>" min="20" max="500" step="0.1" required>
                        </div>
                    </div>

                    <div class="form-group-advanced">
                        <label class="form-label-advanced">Activity Level</label>
                        <select name="activityLevel" class="form-input-advanced" required>
                            <option value="sedentary" <%= user.activityLevel === 'sedentary' ? 'selected' : '' %>>
                                üò¥ Sedentary (little or no exercise)
                            </option>
                            <option value="lightly_active" <%= user.activityLevel === 'lightly_active' ? 'selected' : '' %>>
                                üö∂ Lightly Active (exercise 1-3 days/week)
                            </option>
                            <option value="moderately_active" <%= user.activityLevel === 'moderately_active' ? 'selected' : '' %>>
                                üèÉ Moderately Active (exercise 3-5 days/week)
                            </option>
                            <option value="very_active" <%= user.activityLevel === 'very_active' ? 'selected' : '' %>>
                                üí™ Very Active (exercise 6-7 days/week)
                            </option>
                            <option value="extremely_active" <%= user.activityLevel === 'extremely_active' ? 'selected' : '' %>>
                                üî• Extremely Active (intense exercise daily)
                            </option>
                        </select>
                    </div>

                    <div class="form-group-advanced">
                        <label class="form-label-advanced">Health Condition (Optional)</label>
                        <input type="text" name="healthCondition" class="form-input-advanced" 
                            value="<%= user.healthCondition %>" placeholder="e.g., Diabetes, Hypertension, None">
                    </div>

                    <button type="submit" class="btn-primary btn-block">
                        <i class="fas fa-save"></i> Update Profile
                    </button>
                </form>
            </div>

            <!-- Right Column: Stats & Security -->
            <div>
                <!-- Account Statistics -->
                <div class="profile-section" style="margin-bottom: 2rem;">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-bar"></i> Account Statistics</h2>
                    </div>
                    <div class="stats-list-enhanced">
                        <div class="stat-item-enhanced">
                            <div class="stat-item-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success-color);">
                                <i class="fas fa-calendar-check"></i>
                            </div>
                            <div>
                                <div class="stat-item-label">Member Since</div>
                                <div class="stat-item-value">
                                    <%= new Date(user.createdAt).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) %>
                                </div>
                            </div>
                        </div>

                        <div class="stat-item-enhanced">
                            <div class="stat-item-icon" style="background: rgba(239, 68, 68, 0.1); color: var(--danger-color);">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div>
                                <div class="stat-item-label">Current Streak</div>
                                <div class="stat-item-value"><%= user.currentStreak %> days</div>
                            </div>
                        </div>

                        <div class="stat-item-enhanced">
                            <div class="stat-item-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning-color);">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div>
                                <div class="stat-item-label">Longest Streak</div>
                                <div class="stat-item-value"><%= user.longestStreak %> days</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Change Password -->
                <div class="profile-section">
                    <div class="section-header">
                        <h2><i class="fas fa-key"></i> Change Password</h2>
                    </div>
                    <form id="changePasswordForm" class="password-form-enhanced">
                        <div class="form-group-advanced">
                            <label class="form-label-advanced">Current Password</label>
                            <input type="password" name="currentPassword" class="form-input-advanced" required>
                        </div>

                        <div class="form-group-advanced">
                            <label class="form-label-advanced">New Password</label>
                            <input type="password" name="newPassword" class="form-input-advanced" minlength="6" required>
                        </div>

                        <div class="form-group-advanced">
                            <label class="form-label-advanced">Confirm New Password</label>
                            <input type="password" name="confirmPassword" class="form-input-advanced" minlength="6" required>
                        </div>

                        <div id="passwordMessage" class="alert" style="display: none;"></div>

                        <button type="submit" class="btn-primary btn-block">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Health Info Box -->
        <div class="info-box" style="margin-top: 2rem;">
            <i class="fas fa-info-circle"></i>
            <div>
                <p style="margin-bottom: 0.5rem;"><strong>BMR:</strong> Calories burned at complete rest (sleeping, breathing)</p>
                <p style="margin-bottom: 0.5rem;"><strong>TDEE:</strong> Total calories needed based on your activity level</p>
                <p><strong>BMI:</strong> Body Mass Index calculated from height and weight</p>
            </div>
        </div>
    </div>
</div>

<style>
.profile-grid-redesigned {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 2rem;
}

.profile-section {
    background: var(--bg-primary);
    border-radius: 16px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.section-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-secondary);
}

.section-header h2 {
    font-size: 1.125rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.profile-form-enhanced,
.password-form-enhanced {
    padding: 1.5rem;
}

.stats-list-enhanced {
    padding: 1.5rem;
    display: grid;
    gap: 1rem;
}

.stat-item-enhanced {
    display: flex;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    transition: all var(--transition-fast);
}

.stat-item-enhanced:hover {
    background: var(--bg-tertiary);
    transform: translateX(5px);
}

.stat-item-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.stat-item-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.stat-item-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--text-primary);
}

@media (max-width: 1024px) {
    .profile-grid-redesigned {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
    // Change Password Form Handler
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const messageDiv = document.getElementById('passwordMessage');
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        try {
            const response = await fetch('/user/profile/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                messageDiv.className = 'alert alert-success';
                messageDiv.innerHTML = '<i class="fas fa-check-circle"></i> ' + result.message;
                messageDiv.style.display = 'block';
                e.target.reset();
            } else {
                messageDiv.className = 'alert alert-error';
                messageDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + 
                    (result.errors ? result.errors.map(e => e.msg).join(', ') : 'Error changing password');
                messageDiv.style.display = 'block';
            }
        } catch (error) {
            messageDiv.className = 'alert alert-error';
            messageDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> An error occurred';
            messageDiv.style.display = 'block';
        }
    });
</script>

<%- include('../partials/footer') %>
